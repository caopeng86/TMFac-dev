document.getElementById('tm-upload').innerHTML='<input style="cursor: pointer;width: 120px;height: 32px;position: absolute;left: 0;top: 0;opacity: 0;z-index: 99999" type="file" id="tm_myFile"><button class="upload-item-btn" id="browseButton" >选择文件</button><div id="uploadInfo" style="display: none"><div id="fileshow" style="position: relative"><div id="filename" style="height: 15px;line-height: 15px"></div><span id="delete" style="font-size: 12px;position: absolute;top: 0;right: 5px;cursor: pointer;display: none;color: #999999;">X</span></div><div id="progress"><div id="progress-bg"></div></div></div>';document.getElementById('tm-upload').style.width="135px";document.getElementById('tm-upload').style.boxSizing="border-box";document.getElementById('tm-upload').style.position="relative";document.getElementById('browseButton').style.width="120px";document.getElementById('browseButton').style.cursor="pointer";document.getElementById('browseButton').style.height="32px";document.getElementById('browseButton').style.border="1px solid #40a9ff";document.getElementById('browseButton').style.color="#40a9ff";document.getElementById('browseButton').style.borderRadius="5px";document.getElementById('browseButton').style.outline="none";document.getElementById('browseButton').style.backgroundColor="#ffffff";document.getElementById('fileshow').style.width="100%";document.getElementById('fileshow').style.paddingRight="15px";document.getElementById('fileshow').style.paddingLeft="5px";document.getElementById('fileshow').style.cursor="pointer";document.getElementById('fileshow').style.borderRadius="5px";document.getElementById('fileshow').style.boxSizing="border-box";document.getElementById('filename').style.margin="0";document.getElementById('filename').style.boxSizing="border-box";document.getElementById('filename').style.fontSize="13px";document.getElementById('filename').style.margin="5px 0";document.getElementById('filename').style.overflow="hidden";document.getElementById('filename').style.textOverflow="ellipsis";document.getElementById('filename').style.whiteSpace="nowrap";document.getElementById('progress').style.width="100%";document.getElementById('progress').style.height="3px";document.getElementById('progress').style.backgroundColor="#f5f5f5";document.getElementById('progress').style.borderRadius="5px";document.getElementById('progress-bg').style.width="0";document.getElementById('progress-bg').style.height="3px";document.getElementById('progress-bg').style.backgroundColor="#1890ff";document.getElementById('progress-bg').style.borderRadius="5px";document.getElementById('fileshow').onmouseover=function(){document.getElementById('delete').style.display='inline-block';document.getElementById('fileshow').style.background="#f5f5f5"};document.getElementById('fileshow').onmouseleave=function(){document.getElementById('delete').style.display='none';document.getElementById('fileshow').style.background="#ffffff"};document.getElementById('delete').addEventListener('click',function(){window.localStorage.removeItem(UP.__input.file_name+'_p');window.localStorage.removeItem(UP.__input.file_name+'_url');window.localStorage.removeItem(UP.__input.file_name+'_chunk');$("#tm_myFile").show().val("");$("#browseButton").html('选择文件');document.getElementById('uploadInfo').style.display='none'},false);var uploadcallback=new function(){this.filepart=function(){return{}};this.complete=function(){return{}}};var UP={__init:function(param){this.__input.param=param},__msg:{done:'上传成功',failed:'上传失败',in:'上传中...',paused:'暂停中...',incomplete:'上传不完整'},__input:{fo:null,isPaused:0,flushStatus:0,param:null,file_obj:null,file_name:null,},__show:function(self){var file,uploadItem=[],uploadItemTpl=$('#file-upload-tpl').html(),size,percent,progress='未上传',uploadVal='开始上传';document.getElementById('uploadInfo').style.display='block';this.__input.file_name=self.files[0].name;$("#tm_myFile").hide();for(var i=0,j=self.files.length;i<j;++i){file=self.files[i];percent=undefined;size=file.size>1024?file.size/ 1024 > 1024 ? file.size /(1024*1024)>1024?(file.size/ (1024 * 1024 * 1024)).toFixed(2) + 'GB' : (file.size /(1024*1024)).toFixed(2)+'MB':(file.size/1024).toFixed(2)+'KB':(file.size).toFixed(2)+'B';percent=window.localStorage.getItem(file.name+'_p');if(percent&&percent!=='100.0'){progress='已上传 '+percent+'%';uploadVal='继续上传'}$("#browseButton").html(uploadVal);document.getElementById("progress-bg").style.width=parseInt(percent)+"%";document.getElementById("filename").innerHTML=file.name}$("#browseButton").attr('data-name',self.files[0].name);$("#browseButton").attr('data-size',self.files[0].size);$("#browseButton").attr('data-state','default');$("#browseButton").attr('value','');$('#upload-list').children('tbody').html(uploadItem.join('')).end().show()},__allUpload:function(self){if(!$(this.__input.param.myFile).val()){$(this.__input.param.myFile).focus()}else{$('#upload-list .upload-item-btn').each(function(){$(this).click()})}},__findTheFile:function(fileName){var files=$(this.__input.param.myFile)[0].files,theFile;for(var i=0,j=files.length;i<j;++i){if(files[i].name===fileName){theFile=files[i];break}}return theFile?theFile:[]},__fileInfo:function(self){var $this=$(self);var eachSize=this.__input.param.eachSize?this.__input.param.eachSize:1024;var info={fileThat:$this,state:$this.attr('data-state'),fileName:$this.attr('data-name'),progress:$this.closest('tr').find('.upload-progress'),eachSize:eachSize,totalSize:$this.attr('data-size'),chunks:function(){return Math.ceil(this.totalSize/this.eachSize)},percent:0,chunk:0};this.__input.file_obj=info;return info},__toUpload:function(self){var that=this;that.__input.fo=self;var file_obj=that.__fileInfo(self);if(file_obj.state==='uploading'){file_obj.fileThat.html('继续上传').attr('data-state','paused');that.__input.isPaused=1}else if(file_obj.state==='paused'||file_obj.state==='default'){var c=window.localStorage.getItem(file_obj.fileName+'_chunk');if((file_obj.chunks()-1)==c){var fileinfo={chunks:file_obj.chunks(),chunk:file_obj.chunk,totalSize:file_obj.totalSize,tmp_file:file_obj.fileName,percent:'100%',data:{}};uploadcallback.complete(fileinfo);return}if(c>1&&that.__input.flushStatus==0){window.localStorage.setItem(file_obj.fileName+'_chunk',++c)}that.__input.isPaused=0;that.__input.flushStatus=1;file_obj.fileThat.html('暂停上传').attr('data-state','uploading');that.__startUpload('first')}},__startUpload:function(times){var that=this;var file_obj=that.__input.file_obj;var tmp_file=window.localStorage.getItem(file_obj.fileName+'_url');file_obj.chunk=window.localStorage.getItem(file_obj.fileName+'_chunk')||0;file_obj.chunk=parseInt(file_obj.chunk,10);var isLastChunk=(file_obj.chunk==(file_obj.chunks()-1)?1:0);if(times==='first'&&isLastChunk===1){window.localStorage.setItem(file_obj.fileName+'_chunk',0);chunk=0;isLastChunk=1}var blobFrom=file_obj.chunk*file_obj.eachSize,blobTo=(file_obj.chunk+1)*file_obj.eachSize>file_obj.totalSize?file_obj.totalSize:(file_obj.chunk+1)*file_obj.eachSize,percent=(100*blobTo/file_obj.totalSize).toFixed(1),timeout=5000,fd=new FormData($(that.__input.param.myFile)[0]);fd.append('theFile',that.__findTheFile(file_obj.fileName).slice(blobFrom,blobTo));fd.append('fileName',file_obj.fileName);fd.append('totalSize',file_obj.totalSize);fd.append('isLastChunk',isLastChunk);fd.append('isFirstUpload',times==='first'?1:0);fd.append('tmp_file',tmp_file);$.ajax({type:'post',url:that.__input.param.ServerUrl,data:fd,processData:false,contentType:false,timeout:timeout,success:function(rs){var fileinfo={chunks:file_obj.chunks(),chunk:file_obj.chunk,totalSize:file_obj.totalSize,tmp_file:file_obj.fileName,percent:'0%',data:{}};if(rs.code===200){window.localStorage.setItem(file_obj.fileName+'_url',rs.data.tmp_file);window.localStorage.setItem(file_obj.fileName+'_p',percent);document.getElementById("progress-bg").style.width=parseInt(percent)+"%";fileinfo.percent=parseInt(percent)+"%";fileinfo.data=rs;uploadcallback.filepart(fileinfo);if(file_obj.chunk===(file_obj.chunks()-1)){file_obj.fileThat.html('选择文件');$(UP.__input.param.myFile).show();}else{window.localStorage.setItem(file_obj.fileName+'_chunk',++file_obj.chunk);if(!that.__input.isPaused)that.__startUpload()}if(rs.data.isLastChunk==1){uploadcallback.complete=function(){return fileinfo};window.localStorage.removeItem(file_obj.fileName+'_p');window.localStorage.removeItem(file_obj.fileName+'_chunk');window.localStorage.removeItem(file_obj.fileName+'_url');$(that.__input.fo).html('上传完成');$(UP.__input.param.myFile).show().val("")}}else if(rs.code===500){fileinfo.data=rs;uploadcallback.filepart(fileinfo)}else if(rs.code===502){window.localStorage.removeItem(file_obj.fileName+'_p');window.localStorage.removeItem(file_obj.fileName+'_chunk');window.localStorage.removeItem(file_obj.fileName+'_url');$("#browseButton").html('上传完成')}else{fileinfo.data=rs;uploadcallback.filepart(fileinfo)}},error:function(){}})}};$(function(){$(UP.__input.param.myFile).change(function(e){UP.__show(this)});$(document).on('click','.upload-item-btn',function(){UP.__toUpload(this)})});UP.__init({myFile:"#tm_myFile",ServerUrl:"/extend/Breakpoint/breakUpload",eachSize:1024000,});